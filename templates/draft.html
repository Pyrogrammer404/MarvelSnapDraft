<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marvel Snap Draft</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container fade-in">
    <h1 class="title">Draft Your Deck</h1>

    <!-- Ban Section -->
    <div id="ban-section" class="ban-section">
      <h2>Ban or Restrict Cards</h2>

      <input type="text" id="banInput" placeholder="Enter card name..." list="cardSuggestions" autocomplete="off" />
      <datalist id="cardSuggestions"></datalist>

      <button onclick="addBan()">Ban</button>
      <div id="bannedCards"></div>
      <button class="start-btn" onclick="startDraft()">Start Draft</button>
    </div>

    <!-- Draft Section -->
    <div id="draft-section" class="draft-section hidden">
      <h2 class="section-header">Pick a Card</h2>

      <div id="cardChoices" class="card-grid"></div>

      <!-- Your deck so far -->
      <div id="deckSection" class="deck-section hidden">
        <h3>Your Deck So Far</h3>
        <div id="deckList" class="deck-grid"></div>
      </div>

      <button id="restartDraft" onclick="restartDraft()" class="restart-btn hidden">Restart Draft</button>
    </div>
  </div>

  <!-- Modal for Deck Completion -->
  <div id="draftModal" class="modal hidden">
    <div class="modal-content">
      <h2>Draft Complete!</h2>
      <p>Your final deck:</p>
      <div id="finalDeck" class="deck-grid"></div>

      <textarea id="deckText" readonly></textarea>
      <div class="modal-buttons">
        <button onclick="copyDeck()">Copy Deck Code</button>
        <button onclick="restartDraft()">Restart Draft</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>© 2025 Marvel Snap Draft — built with <span class="heart">❤️</span> by <strong>Shivang Parnami</strong></p>
  </footer>

  <script>
    console.log("✅ draft.js loaded");

    let banned = JSON.parse(localStorage.getItem("bannedCards") || "[]");
    let allCards = [];
    let chosenCards = [];

    // Load all cards
    fetch("/static/data/cards_enriched.json")
      .then(res => res.json())
      .then(data => {
        allCards = data.filter(c => c.collectible);
        console.log("✅ Loaded", allCards.length, "cards");
        fillSuggestions();
        showBans();
      })
      .catch(err => console.error("❌ Error loading cards:", err));

    function fillSuggestions() {
      const dataList = document.getElementById("cardSuggestions");
      dataList.innerHTML = "";
      allCards.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.name;
        dataList.appendChild(opt);
      });
    }

    // Ban logic
    function addBan() {
      const input = document.getElementById("banInput");
      const card = input.value.trim();
      if (!card) return;

      if (!allCards.some(c => c.name === card)) {
        alert("⚠️ Invalid card name!");
        input.value = "";
        return;
      }

      if (!banned.includes(card)) {
        banned.push(card);
        localStorage.setItem("bannedCards", JSON.stringify(banned));
        showBans();
      }
      input.value = "";
    }

    function showBans() {
      const div = document.getElementById("bannedCards");
      div.innerHTML = banned.length
        ? banned.map(c => `<span>${c}<button onclick="unban('${c}')">✕</button></span>`).join("")
        : "<p>No banned cards</p>";
    }

    function unban(card) {
      banned = banned.filter(c => c !== card);
      localStorage.setItem("bannedCards", JSON.stringify(banned));
      showBans();
    }

    // Draft logic
    function startDraft() {
      chosenCards = [];
      document.getElementById("ban-section").classList.add("hidden");
      document.getElementById("draft-section").classList.remove("hidden");
      document.getElementById("deckSection").classList.remove("hidden");
      nextRound();
    }

    function nextRound() {
      if (chosenCards.length >= 12) {
        finishDraft();
        return;
      }

      const available = allCards.filter(c => !chosenCards.includes(c) && !banned.includes(c.name));
      const randomChoices = shuffle(available).slice(0, 4);

      const container = document.getElementById("cardChoices");
      container.innerHTML = randomChoices.map(c => `
        <div class="card">
          <img src="https://snapjson.untapped.gg/art/render/framebreak/common/256/${c.defId}.webp"
               onerror="this.src='https://snapjson.untapped.gg/art/render/framebreak/common/256/Unknown.webp'">
          <h3>${c.name}</h3>
          <p><strong>Cost:</strong> ${c.cost ?? "?"} | <strong>Power:</strong> ${c.power ?? "?"}</p>
          <p class="desc">${c.description || ""}</p>
          <div class="card-buttons">
            <button class="pick-btn" onclick="pickCard('${c.defId}')">Pick</button>
            <button class="dont-btn" onclick="shuffleCard('${c.defId}')">Don't have</button>
          </div>
        </div>
      `).join("");

      updateDeckView();
    }

    function pickCard(defId) {
  const card = allCards.find(c => c.defId === defId);
  if (card) {
    chosenCards.push(card);
    updateDeckView();
    if (chosenCards.length >= 12) {
      finishDraft();
    } else {
      nextRound();
    }
  }
}

    function shuffleCard(defId) {
      const container = document.getElementById("cardChoices");
      const available = allCards.filter(c => !chosenCards.includes(c) && !banned.includes(c.name));
      const newCard = available[Math.floor(Math.random() * available.length)];
      const targetCard = container.querySelector(`img[src*="${defId}"]`).closest(".card");

      if (targetCard && newCard) {
        targetCard.innerHTML = `
          <img src="https://snapjson.untapped.gg/art/render/framebreak/common/256/${newCard.defId}.webp"
               onerror="this.src='https://snapjson.untapped.gg/art/render/framebreak/common/256/Unknown.webp'">
          <h3>${newCard.name}</h3>
          <p><strong>Cost:</strong> ${newCard.cost ?? "?"} | <strong>Power:</strong> ${newCard.power ?? "?"}</p>
          <p class="desc">${newCard.description || ""}</p>
          <div class="card-buttons">
            <button class="pick-btn" onclick="pickCard('${newCard.defId}')">Pick</button>
            <button class="dont-btn" onclick="shuffleCard('${newCard.defId}')">Don't have</button>
          </div>
        `;
      }
    }

    function updateDeckView() {
      const deckDiv = document.getElementById("deckList");
      const sorted = [...chosenCards].sort((a, b) => (a.cost - b.cost) || (b.power - a.power));
      deckDiv.innerHTML = sorted.map(c => `
        <div class="deck-card">
          <img src="https://snapjson.untapped.gg/art/render/framebreak/common/256/${c.defId}.webp"
               onerror="this.src='https://snapjson.untapped.gg/art/render/framebreak/common/256/Unknown.webp'">
          <span>${c.name}</span>
          <small>Cost ${c.cost ?? "?"} | Power ${c.power ?? "?"}</small>
        </div>
      `).join("");
    }

    async function finishDraft() {
  updateDeckView();

  document.getElementById("cardChoices").innerHTML = "<p>⏳ Generating deck code...</p>";

  try {
    const res = await fetch("/api/deckcode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
  cards: chosenCards.map(c => c.defId || c.name.replace(/\s+/g, ""))
})
    });

    const data = await res.json();
    const deckCode = data.deck_code || "Error generating code";

    // Render final deck visually
    const finalDeck = document.getElementById("finalDeck");
    finalDeck.innerHTML = chosenCards.map(c => `
      <div class="deck-card">
        <img src="https://snapjson.untapped.gg/art/render/framebreak/common/256/${c.defId}.webp"
             onerror="this.src='https://snapjson.untapped.gg/art/render/framebreak/common/256/Unknown.webp'">
        <span>${c.name}</span>
        <small>Cost ${c.cost ?? "?"} | Power ${c.power ?? "?"}</small>
      </div>
    `).join("");

    document.getElementById("deckText").value = deckCode;
    document.getElementById("draftModal").classList.remove("hidden");
  } catch (err) {
    console.error("❌ Deck generation failed:", err);
    alert("Error generating deck code. Please try again!");
  }
}


    function copyDeck() {
      navigator.clipboard.writeText(document.getElementById("deckText").value);
      alert("Deck copied to clipboard!");
    }

    function restartDraft() {
      location.reload();
    }

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }
  </script>
</body>
</html>
